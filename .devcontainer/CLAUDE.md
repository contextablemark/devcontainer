<claude-mem-context>
# Recent Activity

<!-- This section is auto-generated by claude-mem. Edit content outside the tags. -->

*No recent activity*
</claude-mem-context>
# CLAUDE.md

This file provides context for Claude Code sessions working with this devcontainer setup.

## Overview

This is a universal, self-contained VS Code Dev Container for OSS development. The container persists everything—workspaces, Claude Code context, git config, gh auth—so you can pick up where you left off or move the container to another machine.

## Architecture

### Two-Stage Approach

1. **Base Image** (`dev-environment`) - Built from Dockerfile, contains all tools
2. **Golden Image** (`dev-environment-golden`) - Base image + VS Code server fully configured

The golden image is created by:
1. Building base image with `./build.sh`
2. Opening in VS Code with "Rebuild and Reopen in Container" to let VS Code install its server
3. Closing VS Code and running `./commit-golden.sh` (handles stopping and cleanup)

New project containers are launched from the golden image, giving a pristine environment with VS Code already set up.

### Key Design Decisions

- **No volumes for workspaces** - Everything lives inside the container for true portability
- **SSH keys bind-mounted read-only** from host (`~/.ssh`)
- **VS Code server** installed in golden image, not rebuilt each time
- **Named containers** - Each project gets its own container (e.g., `ag-ui`, `other-project`)
- **`--entrypoint ""`** in launch.sh - Required because `docker commit` captures VS Code's entrypoint, which breaks `sleep infinity`

## Scripts

| Script | Purpose |
|--------|---------|
| `./build.sh` | Build base image from Dockerfile |
| `./launch.sh [name]` | Launch container from golden image (required) |
| `./stop.sh [name]` | Stop a running container |
| `./commit-golden.sh [name]` | Clean user data, stop container, commit as golden image |

### What commit-golden.sh cleans

- VS Code server state and extensions
- Claude, GitHub CLI, and git auth/config
- Shell history and package manager caches

Note: Workspace contents are NOT cleaned because ~/workspaces may be bind-mounted from the host during golden image creation.

## File Structure

devcontainer/
├── build.sh
├── launch.sh
├── stop.sh
├── commit-golden.sh
├── README.md
├── CLAUDE.md (this file)
└── .devcontainer/
    ├── Dockerfile
    ├── devcontainer.json
    └── post-create.sh

## What's Installed

- Python 3.12 (built from source)
- Node.js 20.x LTS
- pnpm, uv (package managers)
- pytest
- Claude Code CLI (`@anthropic-ai/claude-code`)
- GitHub CLI (gh)
- Zsh
- Common build tools

### Claude Code Configuration

- **MCP Server**: deepwiki (`https://mcp.deepwiki.com/mcp`) - preconfigured in `~/.claude.json`

## Common Tasks

### Rebuild after Dockerfile changes

./build.sh
# Open in VS Code → "Rebuild and Reopen in Container"
# Close VS Code when done
./commit-golden.sh

### Launch a new project container

./launch.sh my-project
# Then in VS Code: "Attach to Running Container" → /my-project

### First-time setup in new container

git config --global user.name "Your Name"
git config --global user.email "you@example.com"
gh auth login
claude

### Clone and work

cd ~/workspaces
git clone git@github.com:org/repo.git

### Move container to another machine

docker commit my-project my-project-snapshot:latest
docker save my-project-snapshot:latest | gzip > my-project.tar.gz
# Transfer file, then on target:
gunzip -c my-project.tar.gz | docker load
docker run -d --name my-project --entrypoint "" my-project-snapshot:latest /bin/sh -c "sleep infinity"

## Troubleshooting

### VS Code `.vscode-server` errors
- Clear VS Code cache: rm -rf ~/Library/Application\ Support/Code/User/globalStorage/ms-vscode-remote.remote-containers
- Remove and rebuild: docker rm -f dev-environment && docker rmi dev-environment dev-environment-golden

### Container crashes on launch
- Check logs: docker logs <container-name>
- Usually caused by entrypoint issues - ensure launch.sh uses --entrypoint ""

### Permission denied in /workspaces
- Use ~/workspaces (owned by developer), not /workspaces (owned by root)

## Working Directory

Inside the container, always use:

cd ~/workspaces
# or
cd /home/developer/workspaces

NOT /workspaces which is VS Code's mount point (owned by root).
